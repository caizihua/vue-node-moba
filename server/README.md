# serveræœåŠ¡ç«¯

ç›®å½•ç»“æž„å¦‚ä¸‹ï¼š

```js
server
â”‚  index.js
â”‚  package-lock.json
â”‚  package.json
â”œâ”€models
â”‚      Category.js
â”‚      Item.js
â”œâ”€plugins
â”‚      db.js
â””â”€routes
    â””â”€admin
            index.js
```

éœ€è¦å®‰è£…`express@next`è¡¨ç¤ºä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œ`mongoose`æ•°æ®åº“ï¼Œ`cors`å…è®¸è·¨åŸŸè¯·æ±‚ã€‚

```bash
npm i express@next mongoose cors --save
```

## ä¸»è¦å†…å®¹ 

### ä¸»ç›®å½•ä¸‹index.js

ä¸»è¦æ˜¯æ³¨å†Œä½¿ç”¨å…¨å±€ä½¿ç”¨çš„æ¨¡å—ç­‰ï¼Œä¾‹å¦‚expressï¼Œcorsç­‰ã€‚

å¹¶å¯åŠ¨æœåŠ¡å™¨ã€‚

```js
//æœåŠ¡ç«¯ä»£ç 
const express = require("express");

const app = express();
//ä½¿ç”¨JSON
app.use(express.json());
//ç›´æŽ¥ä½¿ç”¨è·¨åŸŸæ¨¡å—
app.use(require("cors")());

require("./routes/admin")(app);
require("./plugins/db")(app);

app.listen(3000, () => {
  console.log("http://localhost:3000");
});
```

### routesç›®å½•

å¯ä»¥å°†routerç­‰è·¯ç”±æ–‡ä»¶å­˜å‚¨åœ¨å½“å‰æ–‡ä»¶å¤¹routesä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹ä¸“é—¨å­˜å‚¨è·¯ç”±ç›¸å…³ä»£ç ã€‚

- adminç›®å½•å­˜å‚¨`ç®¡ç†ç«¯`ç›¸å…³çš„è·¯ç”±ä»£ç ï¼š

  ```js
  //router/admin/index.js
  //å…³äºŽadminç«¯çš„è·¯ç”±
  module.exports = (app) => {
    const express = require("express");
    //å®šä¹‰expressçš„å­è·¯ç”±
    //è¿™ä¸ªå­è·¯ç”±é‡Œé¢æœ‰æˆ‘ä»¬å°è£…çš„å‡½æ•°
    //å› ä¸ºéœ€è¦å°†å­è·¯ç”±æŒ‚è½½å‡ºåŽ»
    const router = express.Router();
    app.use("/admin/api", router);
  };
  ```

**admin**è¿™é‡Œæ˜¯å¯¼å‡ºäº†ä¸€ä¸ª`å‡½æ•°`ï¼Œè¿™ä¸ªå‡½æ•°æŽ¥å—ä¸€ä¸ªå‚æ•°appå¯¹è±¡ã€‚

**ä¸»æ–‡ä»¶index.js**ä¸­`require`äº†adminï¼Œå› ä¸ºå¯¼å‡ºçš„æ˜¯å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥ä¼ å‚ï¼Œåˆå› ä¸ºå¼•ç”¨äº†appï¼Œæ‰€ä»¥å¯ä»¥å°†appä½œä¸ºå‚æ•°ä¼ ç»™adminä¸­çš„æ–‡ä»¶ã€‚

```js
//server/index.js
require("./routes/admin")(app);
```

### pluginsç›®å½•

ðŸ’¦æ–°å»º`plugins`æ–‡ä»¶å¤¹å­˜æ”¾æ•°æ®åº“ä»£ç ï¼Œæ–°å»ºdb.jsï¼Œä½œä¸ºè¿žæŽ¥æ•°æ®åº“ç­‰æ“ä½œçš„æ–‡ä»¶ã€‚

```js
module.exports = (app) => {
  const mongoose = require("mongoose");
  mongoose.connect("mongodb://127.0.0.1:27017/vue-node-moba", {
    useNewUrlParser: true,
  });
};
```

### modelsç›®å½•

ðŸ’¦åˆ›å»ºæ¨¡åž‹æ–‡ä»¶å¤¹`models`,é‡Œé¢å°è£…çš„å°±æ˜¯æ•°æ®åº“ç­‰çš„æ¨¡åž‹æ–‡ä»¶ã€‚

åˆ›å»º`Category.js`ä½œä¸ºåˆ†ç±»çš„æ•°æ®åº“æ¨¡åž‹æ–‡ä»¶ã€‚

```js
//åˆ›å»ºmongoæ¨¡åž‹æ–‡ä»¶
//å°è£…å¥½åŽå“ªé‡Œéœ€è¦è¿™ä¸ªæ¨¡åž‹å°±åœ¨å“ªé‡Œå¼•ç”¨
const mongoose = require("mongoose");
const schema = new mongoose.Schema({
  name: { type: String },
});
module.exports = mongoose.model("Category", schema);
```

## é€šç”¨CRUD

æœ€å¼€å§‹æ—¶ï¼Œåªæœ‰åˆ†ç±»çš„å„ç§å¢žåˆ æŸ¥æ”¹ï¼Œéšç€éœ€æ±‚çš„å¢žåŠ ï¼Œä¼šæœ‰å…¶ä»–æ•°æ®çš„å¢žåˆ æŸ¥æ”¹ï¼Œæ¯”å¦‚è¯´ç‰©å“ï¼Œæ–°é—»èµ„è®¯ç­‰ï¼Œæ‰€ä»¥éœ€è¦ä¸€å¥—é€šç”¨çš„crudæŽ¥å£æ¥å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œå¢žåˆ æŸ¥æ”¹ï¼Œå¯¹äºŽæŸäº›ç‰¹æ®Šçš„æ•°æ®å†è¿›è¡Œç‰¹æ®Šåœ°å¤„ç†ã€‚ 

```js
module.exports = (app) => {
  const express = require("express");
  const router = express.Router({
    //è¿™ä¸ªå‚æ•°è¡¨ç¤ºå°†åŠ¨æ€resourceèƒ½ä¼ é€’ç»™routerï¼Œè¿™æ ·routeré‡Œé¢çš„è·¯ç”±å°±èƒ½ä½¿ç”¨è¿™äº›å‚æ•°
    mergeParams: true,
  });
  //åŠ¨æ€çš„resourceæŽ¥å—æŽ¥å£å‚æ•°
  //æ’å…¥ä¸­é—´ä»¶ï¼Œå½“è°ƒç”¨æŽ¥å£æ˜¯å…ˆè°ƒç”¨å‡½æ•°ï¼Œå‡ºçŽ°next()æ‰å¤„ç†æŽ¥ä¸‹æ¥çš„
  app.use(
    "/admin/api/rest/:resource",
    (req, res, next) => {
      //å¼•å…¥æ¨¡å—å¤„ç†å•å¤æ•°è½¬æ¢ï¼Œä¸‹åˆ’çº¿å•è¯çš„æ ¼å¼è½¬æ¢ç­‰
      //classifyè½¬ç±»å
      const modelName = require("inflection").classify(req.params.resource);
      //åœ¨reqä¸­æŒ‚è½½
      req.Model = require(`../../models/${modelName}`);
      next();
    },
    router
  );
  const multer = require("multer");
  app.use("/admin/api/upload", async (req, res) => {});
};
```

- æ›´æ”¹æŽ¥å£ï¼Œè¿™é‡Œå°±é€šè¿‡`rest/:resource`åŠ¨æ€åœ°æŽ¥å—æŽ¥å£æ•°æ®ï¼Œè¿™é‡Œçš„resourceå°±æ˜¯å‰ç«¯è¯·æ±‚çš„æŸä¸ªæŽ¥å£ï¼Œé€šè¿‡è¿™ä¸ªæŽ¥å£ï¼Œæ‰¾åˆ°ç›¸åº”çš„schemaï¼Œè¿”å›žç»™å‰ç«¯ç›¸åº”çš„æ•°æ®ã€‚

- å½“è¦ä¸ºæŸä¸ªschemaè¿›è¡Œæ“ä½œæ—¶ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨çš„å°±æ˜¯Modelï¼Œè€Œè¿™ä¸ªModelæ˜¯é€šè¿‡çˆ¶çº§å‚æ•°ä¸­å¾—åˆ°çš„æ¨¡åž‹ã€‚

> æ³¨æ„ï¼š
>
> - app.useæŽ¥å—çš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æ˜¯ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å……å½“ä¸­é—´ä»¶çš„ä½œç”¨ï¼Œå¯¹å‰é¢çš„æŽ¥å£è¿›è¡Œå¤„ç†ï¼Œå½“å¤„ç†å®ŒåŽé€šè¿‡next()ï¼Œæ‰§è¡ŒåŽé¢çš„äº‹å®œï¼Œrouterã€‚
>- å®šä¹‰routeræ—¶æŽ¥å£ä¸€ä¸ªå‚æ•°mergeParamsï¼Œ**å¯¼å…¥çˆ¶çº§å‚æ•°åˆ°å­çº§é…ç½®ä¸­**ã€‚è¿™ä¸ªå‚æ•°å°±æ˜¯å¯ä»¥åŠ¨æ€åœ°å°†æŽ¥å£ä¸­çš„resourceå‚æ•°ä¼ ç»™routerï¼Œè¿™æ ·routerä¸­å…·ä½“çš„è·¯ç”±å°±å¯ä»¥ä½¿ç”¨è¿™äº›å‚æ•°ã€‚
> - å‰ç«¯è¯·æ±‚çš„æŽ¥å£resourceå…·ä½“ä¼šæ˜¯å°å†™å¼€å¤´å¤æ•°å½¢å¼ï¼Œæ¯”å¦‚è¯´categoriesï¼Œè€Œå¯¹åº”çš„schemaæ˜¯å¤§å†™å•æ•°çš„å½¢å¼å¦‚Categoryï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥æ¨¡å—è¿›è¡Œå•å¤æ•°è½¬æ¢ï¼Œè¿™ä¸ªæ¨¡å—å°±æ˜¯**inflection**ã€‚
>- æœ€åŽå°†å¾—åˆ°çš„schemaæŒ‚è½½åˆ°reqä¸­å°±å¯ä»¥å¼•ç”¨äº†ã€‚

```js
app.use("/admin/api/rest/:resource", async (req, res, next) => {
  const modelName = require('inflection').classify(req.params.resource);
  req.Model = require(`../../models/${modelName}`);
  next();
}, router);
```

å¯¹äºŽåˆ†ç±»åˆ—è¡¨ä¸­çˆ¶çº§åˆ†ç±»çš„æ“ä½œï¼Œåœ¨é€šç”¨crudä¸­å°±ä¸èƒ½å†™æ­»ï¼Œå› ä¸ºæœ‰çš„æ¨¡åž‹ä¸é€‚ç”¨äºŽCategoryæ¨¡åž‹å®šä¹‰çš„çˆ¶çº§åˆ†ç±»è¿™ç§ç‰¹æ®Šåˆ†ç±»ã€‚æ‰€ä»¥éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚

åˆ¤æ–­å¦‚æžœå‰ç«¯ä¼ æ¥çš„æ¨¡åž‹æ˜¯Categoryæ—¶ï¼Œå°±æ·»åŠ populateå±žæ€§ã€‚

populateè¡¨ç¤ºå…³è”å–å‡ºä»€ä¹ˆä¸œè¥¿ï¼Œå¦‚æžœä¼ å…¥çš„å­—æ®µæ˜¯å…³è”å­—æ®µå°±èƒ½æŸ¥å‡ºæ¥ï¼Œå…³è”æŸ¥è¯¢å‡ºæ¥çš„å°±æ˜¯ä¸€ä¸ªåŒ…å«å®Œæ•´ä¿¡æ¯çš„å¯¹è±¡ã€‚è¿™ä¸ªå…³è”çš„æ˜¯parentï¼Œæ‰€ä»¥å°±ä¼šå°†çˆ¶çº§çš„æ‰€æœ‰ä¿¡æ¯ä½œä¸ºä¸€ä¸ªå¯¹è±¡å–å‡ºè¿”å›žç»™å‰ç«¯ã€‚

```js
router.get("/", async (req, res) => {
	//ä¸åº”è¯¥æ˜¯å†™æ­»çš„parentå› ä¸ºå¯èƒ½æœ‰çš„æ¨¡åž‹æ²¡æœ‰parent
	//åˆ¤æ–­æ˜¯å¦ä¸ºåˆ†ç±»æ¨¡åž‹ï¼Œå¦‚æžœæ˜¯çš„è¯ï¼Œæ·»åŠ populate
	const queryOptions = {};
	if (req.Model.modelName === "Category") {
  		queryOptions.populate = "parent";
	}
	const items = await req.Model.find().setOptions(queryOptions).limit(10);
	res.send(items);
});
```

## å›¾ç‰‡ä¸Šä¼ 

- å¦‚æžœéœ€è¦å›¾ç‰‡ä¸Šä¼ ï¼Œå¯ä»¥ä½¿ç”¨multeræ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—æ˜¯ç”¨äºŽå¤„ç†`form-data`æˆ–è€…`multipart`

  multerä¼šæ·»åŠ fileå¯¹è±¡åˆ°reqä¸­ï¼Œreqä¸­åŒ…å«è¡¨å•ä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯ã€‚

  è¡¨å•ä¸­å¯ä»¥è®¾ç½®destå±žæ€§ï¼Œè¡¨ç¤ºå­˜å‚¨åœ¨å“ªé‡Œã€‚

  `single`æŽ¥å—å•ä¸ªæ–‡ä»¶çš„ä¸Šä¼ åå­—ä¸ºfileï¼Œå› ä¸ºæŽ¥å£formDataä¸­çš„åå­—å°±æ˜¯fileã€‚

- å°†fileå¯¹è±¡å–å‡ºï¼Œè®¾ç½®è®¿é—®è·¯å¾„`file.url`ã€‚

  fileå¯¹è±¡ä¸­æœ‰filenameå°±æ˜¯å›¾ç‰‡çš„äºŒè¿›åˆ¶åç§°ã€‚

  å°†fileå†å‘å‡ºã€‚

```js
//å…³äºŽadminç«¯çš„è·¯ç”±
module.exports = (app) => {
  const multer = require("multer");
  const upload = multer({ dest: __dirname + "/../../uploads" });
  app.post("/admin/api/upload", upload.single("file"), async (req, res) => {
    const file = req.file;
    //æ·»åŠ è®¿é—®è·¯å¾„ï¼Œå…·ä½“çš„å°±æ˜¯fileé‡Œé¢çš„filenameï¼Œæ˜¯äºŒè¿›åˆ¶æ•°æ®
    file.url = `http://localhost:3000/uploads/${file.filename}`;
    res.send(file);
  });
};
```

## è‹±é›„ç®¡ç†

è‹±é›„çš„ç±»åž‹åº”è¯¥æ˜¯å¯é€‰çš„ï¼Œè€Œä¸æ˜¯è¾“å…¥çš„ï¼Œå¹¶ä¸”ä¿å­˜çš„ä¹Ÿåº”è¯¥æ˜¯ç±»åž‹çš„`_id`ã€‚

è€Œä¸”è¿™ä¸ªåˆ†ç±»ï¼ŒæŸäº›è‹±é›„èŒä¸šå¯èƒ½ä¸æ­¢ä¸€ä¸ªï¼Œæ‰€ä»¥è¿˜éœ€è¦å¤šé€‰ã€‚å¯ä»¥ä½¿ç”¨æ•°ç»„æ¥ä¿å­˜å¤šä¸ªå€¼ã€‚

```js
//server/models/Hero.js
const mongoose = require("mongoose");

const schema = new mongoose.Schema({
  name: { type: String },
  avatar: { type: String },
  title: { type: String },
  // è¿™é‡Œçš„å…³è”æ¨¡åž‹å°±æ˜¯Categoryï¼Œå› ä¸ºéœ€è¦åœ¨åˆ†ç±»æ¨¡åž‹ä¸­é€‰æ‹©èŒä¸šçš„ç±»åž‹
  //è¿™é‡Œä½¿ç”¨æ•°ç»„è¡¨ç¤ºå¯ä»¥å…³è”å¤šä¸ª
  category: [{ type: mongoose.SchemaTypes.ObjectId, ref: "Category" }],
  //å®šä¹‰äº†å¤åˆç±»åž‹ï¼Œæ›´åƒæ˜¯å¯¹è±¡çš„å±žæ€§
  //è¯„åˆ†
  scores: {
    difficult: { type: Number },
    skills: { type: Number },
    attack: { type: Number },
    survive: { type: Number },
  },
  //æŠ€èƒ½
  skills: [
    {
      icon: { type: String },
      name: { type: String },
      description: { type: String },
      tips: { type: String },
    },
  ],
  //é¡ºé£Žé€†é£Žå‡ºè£…
  items1: [{ type: mongoose.SchemaTypes.ObjectId, ref: "Item" }],
  items2: [{ type: mongoose.SchemaTypes.ObjectId, ref: "Item" }],
  //ä½¿ç”¨æŠ€å·§
  usageTips: { type: String },
  //å¯¹æˆ˜æŠ€å·§
  battleTips: { type: String },
  //å›¢é˜ŸæŠ€å·§
  teamTips: { type: String },
  //è‹±é›„å…³ç³» æ­æ¡£
  partners: [
    {
      hero: { type: mongoose.SchemaTypes.ObjectId, ref: "Hero" },
      description: { type: String },
    },
  ],
});
module.exports = mongoose.model("Hero", schema);
```

## å¹¿å‘Šç®¡ç†

å¹¿å‘Šç®¡ç†ä¸­çš„schemaæ¨¡åž‹ä¸­åº”è¯¥åŒ…å«å¹¿å‘Šæ ‡é¢˜å’Œå¹¿å‘Šå†…å®¹ï¼Œè¿™é‡Œçš„å†…å®¹ä½¿ç”¨æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«å›¾ç‰‡è¿˜æœ‰è·³è½¬é“¾æŽ¥ã€‚

```js
const mongoose = require("mongoose");
const schema = new mongoose.Schema({
  name: { type: String },
  items: [
    {
      image: { type: String },
      url: { type: String },
    },
  ],
});
module.exports = mongoose.model("Ad", schema);
```

## ç®¡ç†å‘˜è´¦å·ç®¡ç†ï¼ˆbcryptï¼‰

ç®¡ç†å‘˜schemaæ¨¡åž‹ä¸­åº”æœ‰ç”¨æˆ·åå’Œå¯†ç ã€‚

```js
const schema = new mongoose.Schema({
  username: { type: String },
  password: {
    type: String, 
    select: false,
    set(val) {
      return require("bcrypt").hashSync(val, 10);
    },
  },
});
```

è¿™é‡Œä¿å­˜å¯†ç æˆ‘ä»¬éœ€è¦è¿›è¡ŒåŠ å¯†ï¼Œä½¿å¾—ç®¡ç†äººå‘˜ä¹Ÿåº”è¯¥ä¸çŸ¥é“å¯†ç ï¼Œæ‰€ä»¥å­˜å…¥æ•°æ®åº“çš„å¯†ç å°±æ˜¯åŠ äº†å¯†çš„å¯†æ–‡ï¼Œä¸”ä¸ä¼šæ›´æ”¹ï¼Œæ‰€ä»¥ä½¿ç”¨`select`ä¸è¢«æ˜¾ç¤ºã€‚

- å¯¹æŸä¸€é¡¹æ•°æ®å¯ä»¥ä½¿ç”¨setå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å¯¹ä¼ å…¥æ•°æ®è¿›è¡Œæ“ä½œå†è¿›è¡Œä¿å­˜ã€‚setå‡½æ•°ä¼ å…¥çš„å‚æ•°å°±æ˜¯åŽŸæœ¬æ•°æ®åº“ä¼ æ¥çš„å€¼ï¼Œæœ€åŽå‡½æ•°ä¸­éœ€è¦è¿”å›žä¸€ä¸ªå€¼ã€‚

  > æ•£åˆ—éœ€è¦æ¨¡å—**bcrypt**ï¼Œå®‰è£…ï¼š`npm  i bcrypt`ï¼Œè¿™ä¸ªæ¨¡å—å°±æ˜¯å¯¹ä¼ å…¥çš„å€¼è¿›è¡ŒåŠ å¯†ï¼Œä½¿ç”¨äº†å•é¡¹hashç®—æ³•ã€‚

- æ¨¡å—ä¸­æœ‰ä¸ªå‡½æ•°`hashSync`ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æŽ¥å—å€¼ï¼Œå°±æ˜¯éœ€è¦åŠ å¯†çš„å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯åŠ å¯†çš„ç­‰çº§ï¼Œç­‰çº§è¶Šé«˜ï¼Œå®‰å…¨æ€§è¶Šé«˜ä½†æ˜¯åŠ å¯†è¶Šè€—æ—¶ï¼Œåä¹‹ç­‰çº§ä½Žåˆ™å®‰å…¨æ€§ä½ŽåŠ å¯†å¿«é€Ÿï¼Œä¸€èˆ¬å–**10-12**ã€‚

è¿™æ ·æ“ä½œä¹‹åŽï¼Œå½“å‰ç«¯ç‚¹å‡»æäº¤æŒ‰é’®æ—¶ï¼Œåœ¨æœåŠ¡ç«¯å°±ä¼šå¯¹å¯†ç è¿›è¡ŒåŠ å¯†ã€‚

å¯†ç åœ¨ç¼–è¾‘ç•Œé¢æ—¶æ˜¯ä¸å¯æŸ¥è¯¢çš„ã€‚è¿™æ ·åšæ˜¯å› ä¸ºå½“å†æ¬¡è¿›å…¥ç¼–è¾‘é¡µé¢ä¿å­˜æ—¶ï¼Œæœªæ£€æµ‹å‡ºå¯†ç ä¹Ÿå°±ä¸ä¼šå†æ¬¡åŠ å¯†ã€‚

## ç™»å½•æŽ¥å£

- åœ¨å‰ç«¯ï¼Œé€šè¿‡ç‚¹å‡»ç™»å½•å°†ç™»å½•çš„ç”¨æˆ·åå’Œå¯†ç ä¼ åˆ°æœåŠ¡å™¨ç«¯æ¥ã€‚åœ¨åŽç«¯ä¸­è¿›è¡Œæ ¡éªŒç”¨æˆ·åæˆ–è€…å¯†ç ç­‰æ“ä½œï¼Œæœ€åŽå°†æ•°æ®è¿”å›žç»™å‰ç«¯ã€‚

- å½“æ ¡éªŒæˆåŠŸåŽï¼ŒæœåŠ¡å™¨ç”Ÿæˆä¸€ä¸²ç§˜é’¥ï¼Œè¿”å›žç»™å‰ç«¯ï¼Œå‰ç«¯å‡­å€Ÿè¿™ä¸²ç§˜é’¥è¯æ˜Žè‡ªå·±æ˜¯å“ªä¸ªç”¨æˆ·ã€‚

1. `req.body`ä¸­å°±åŒ…å«äº†ç”¨æˆ·åå’Œå¯†ç ï¼Œé€šè¿‡è§£æž„èµ‹å€¼è§£æž„å‡ºæ¥ã€‚

2. æ ¹æ®ç”¨æˆ·åæ‰¾ç”¨æˆ·ã€‚åˆ¤æ–­ç”¨æˆ·åä¸å­˜åœ¨çš„æƒ…å†µã€‚

   > å› ä¸ºä¹‹å‰æ˜¾å¼åœ°ä¸èƒ½æŸ¥è¯¢å¯†ç ï¼Œåœ¨è¿™é‡Œä¹‹åŽçš„æ“ä½œä¸­éœ€è¦æ ¡éªŒå¯†ç ï¼Œæ‰€ä»¥è¿˜è¦ä½¿ç”¨selectå­—æ®µé‡æ–°å¼ºåˆ¶å–å‡ºå¯†ç ã€‚

3. æ ¡éªŒå¯†ç ï¼Œåˆ¤æ–­å¯†ç é”™è¯¯çš„æƒ…å†µã€‚

   > æ˜Žæ–‡ä¸Žå¯†æ–‡çš„æ¯”å¯¹ä¹Ÿæ˜¯ä½¿ç”¨bcryptæ¨¡å—ï¼Œä¹‹å‰åŠ å¯†æ˜¯ä½¿ç”¨hashSyncï¼Œè¿™é‡Œæ¯”å¯¹å°±æ˜¯ä½¿ç”¨compareSyncï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯å‰ç«¯ä¼ å…¥çš„å¯†ç ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æ•°æ®åº“ä¿å­˜çš„å¯†æ–‡ã€‚

4. æ­¤æ—¶å…¨éƒ¨éƒ½æ­£ç¡®ï¼Œå‘é€tokenã€‚

   > éœ€è¦ä½¿ç”¨jsonwebtokenè¿™ä¸ªæ¨¡å—è¿”å›žtokenï¼Œå®ƒæœ‰ä¸ªæ–¹æ³•å°±æ˜¯signç”Ÿæˆä¸€ä¸ªç­¾åï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯éœ€è¦åŠ å¯†ä¿å­˜åœ¨å‰ç«¯çš„ä¿¡æ¯ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç§˜é’¥ï¼Œé€šè¿‡è¿™ä¸ªç§˜é’¥å†ä½¿ç”¨ç®—æ³•æ¥ç”Ÿæˆä¸€ä¸ªtokenï¼Œå®¢æˆ·ç«¯æ˜¯å¯ä»¥ä¸éœ€è¦ç§˜é’¥å°±éž¥è§£å¯†å®ƒçš„ï¼Œä½†æ˜¯éœ€è¦éªŒè¯ï¼ˆjwt.verifyï¼‰æ­£ç¡®æ€§ã€‚
   >
   > `app.get`å½“åªæœ‰ä¸€ä¸ªå‚æ•°æ—¶ï¼Œå°±æ˜¯èŽ·å–ç§˜å¯†å­—æ®µã€‚

```js
  app.post("/admin/api/login", async (req, res) => {
    const { username, password } = req.body; 
    const user = await AdminUser.findOne({ username }).select("+password");
    assert(username !== "", 422, "è¯·è¾“å…¥ç”¨æˆ·å");
    assert(user, 422, "ç”¨æˆ·ä¸å­˜åœ¨");
    //æ ¡éªŒå¯†ç ,å°†æ˜Žæ–‡å’Œå¯†æ–‡è¿›è¡Œæ¯”å¯¹
    const isValid = require("bcrypt").compareSync(password, user.password);
    assert(isValid, 422, "å¯†ç é”™è¯¯");
    //è¿”å›žtoken
    const token = jwt.sign(
      {
        id: user._id,
      },
      app.get("secret")
    );
    res.send({ token });
  });
```

è®¾ç½®tokenç”Ÿæˆæ—¶ä½¿ç”¨çš„ç§˜é’¥ã€‚è¿™é‡Œéœ€è¦åœ¨serverä¸‹çš„index.jsä¸­å…¨å±€è®¾ç½®ã€‚

`app.set`è®¾ç½®ç§˜å¯†å­—æ®µï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯åç§°`secret`ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å­—æ®µå…·ä½“å†…å®¹ã€‚

```js
var fs = require("fs");
// å…¨å±€ä¸­é…ç½®ç§˜å¯†å­—æ®µ
fs.readFile(__dirname + "/a.txt", function (err, data) {
  if (err) {
    return err;
  } else {
    app.set("secret", data.toString());
  }
});
```

### æœåŠ¡å™¨ç™»å½•æ ¡éªŒï¼ˆjwtï¼‰

> **ä¸ºä»€ä¹ˆéœ€è¦tokenï¼Ÿ**
>
> å‰ç«¯æœ¬åœ°ä¿ç•™çš„tokenæ˜¯ä¸ºäº†è¿›è¡Œç™»å½•æ ¡éªŒã€‚
>
> å½“æ²¡æœ‰è¿›è¡ŒtokenéªŒè¯æ—¶ï¼Œå‰ç«¯ä¸èƒ½è®¿é—®ç®¡ç†é¡µé¢çš„æ•°æ®ã€‚
>
> åªæœ‰è¿›è¡Œäº†tokenéªŒè¯ï¼Œæ‰è¡¨ç¤ºæ˜¯ç™»å½•æˆåŠŸçš„ç®¡ç†å‘˜ï¼Œæ‰æœ‰æƒç®¡ç†æ•°æ®ã€‚

ä½¿ç”¨åˆ°ä¸­é—´ä»¶è¿›è¡ŒtokenéªŒè¯ï¼Œå½“è¿›è¡Œèµ„æºè¯·æ±‚æ—¶ï¼Œå°±è¿›è¡Œtokençš„éªŒè¯ã€‚å½“tokenä¸åŒ¹é…æ—¶ä¸èƒ½è®©å‰ç«¯è¿›è¡Œè®¿é—®ã€‚

1. æœåŠ¡å™¨ç«¯æŽ¥æ”¶åˆ°å‰ç«¯ä¼ æ¥çš„æŽˆæƒä¿¡æ¯`Authorization`ã€‚åˆ†å‰²å¼€å–å¾—åŽé¢éƒ¨åˆ†çš„tokenå¯†æ–‡ã€‚

   > åŽç«¯é‡Œçš„æŽˆæƒä¿¡æ¯æ˜¯å°å†™ï¼Œå‰ç«¯é‡Œçš„æ˜¯å¤§å†™ã€‚

2. ä½¿ç”¨`verify`æ–¹æ³•éªŒè¯tokenæ­£ç¡®æ€§ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯å‰ç«¯ä¼ æ¥çš„tokenï¼Œç¬¬äºŒä¸ªå°±æ˜¯secretå­—æ®µã€‚

   > jsonwebtokenä¸­æœ‰decodeæ–¹æ³•è¡¨ç¤ºè§£å¼€tokenï¼Œä½†æ˜¯ä¸ä¼šéªŒè¯å¯¹é”™,verifyè§£æžtokenæå–å‡ºidã€‚

3. è§£æžæ­£ç¡®æ—¶ä¼šåŒ…å«ç€ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè¿™é‡Œä¹‹å‰è®¾ç½®çš„åŠ å¯†çš„å°±æ˜¯**id**ï¼Œæ‰€ä»¥å–å‡ºidã€‚

4. æ ¹æ®idæŸ¥æ‰¾åˆ°ç›¸åº”çš„userï¼Œæ·»åŠ åˆ°reqä¸­ï¼Œä»¥ä¾¿ä¹‹åŽä½¿ç”¨ã€‚ç›¸åº”çš„ç”¨æˆ·å±•ç¤ºç›¸åº”çš„æ•°æ®ã€‚

```js
  const authMiddleware = async (req, res, next) => {  
    const token = String(req.headers.authorization || "")
      .split(" ")
      .pop(); 
    assert(token, 401, "è¯·å…ˆç™»å½•"); 
    const { id } = jwt.verify(token, app.get("secret"));
    assert(id, 401, "è¯·å…ˆç™»å½•");
    req.user = await AdminUser.findById(id);
    assert(req.user, 401, "è¯·å…ˆç™»å½•");
    next();
  };
```

### æœåŠ¡å™¨ç™»å½•æ ¡éªŒï¼ˆassertï¼‰

`http-assert`æ˜¯ä¸€ä¸ªnpmåŒ…ï¼Œä¸»è¦ç”¨äºŽå¤„ç†é”™è¯¯ï¼Œèƒ½æ›´ç®€æ´æ–¹ä¾¿å¿«é€Ÿåœ°å¤„ç†é”™è¯¯ã€‚

>**assert(token, 401, "è¯·å…ˆç™»å½•");** 
>
>ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æ¡ä»¶ï¼Œéœ€è¦æ»¡è¶³è¿™ä¸ªæ¡ä»¶ã€‚
>
>ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯çŠ¶æ€ç ï¼Œå½“ä¸æ»¡è¶³è¿™ä¸ªæ¡ä»¶æ—¶è¿”å›žçš„çŠ¶æ€ç ã€‚
>
>ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯è¿”å›žé”™è¯¯æ—¶çš„messageã€‚

### æœåŠ¡å™¨ç™»å½•æ ¡éªŒï¼ˆä¸­é—´ä»¶ï¼‰

å°†ä¹‹å‰å®šä¹‰çš„`authMiddleware`éªŒè¯æ–¹æ³•æ”¾è‡³è¯·æ±‚èµ„æºå‡½æ•°ä¸­åŽ»ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªä¸­é—´ä»¶ã€‚

è¿™æ˜¯è¯·æ±‚èµ„æºçš„æŽ¥å£ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªä¸­é—´ä»¶ã€‚

- ç¬¬ä¸€ä¸ªä¸­é—´ä»¶æ˜¯éªŒè¯å‰ç«¯ä¼ æ¥çš„tokenã€‚
- ç¬¬äºŒä¸ªæŽ¥å£æ˜¯å¯¹æ¨¡åž‹åè¿›è¡Œå•å¤æ•°å¤§å°å†™å˜åŒ–ï¼Œåœ¨reqä¸­æŒ‚è½½æ•°æ®åº“Modelï¼Œè¿™æ ·æ ¹æ®å‰ç«¯çš„æŽ¥å£ï¼Œå°±èƒ½ç›´æŽ¥å¯¹ç›¸åº”çš„modelè¿›è¡Œè®¿é—®ã€‚
- æœ€åŽæŒ‚è½½è·¯ç”±ã€‚

```js
  app.use(
    "/admin/api/rest/:resource",
    authMiddleware(),
    resourceMiddleware(),
    router
  );
```

è¿™é‡Œçš„ä¸­é—´ä»¶åˆå¯ä»¥é‡æ–°å°è£…åœ¨ä¸åŒæ–‡ä»¶ä¸­ã€‚

```shell
middleware
â”‚  auth.js
â”‚  resource.js
```

è¿™é‡Œå¯¼å‡ºçš„ä½¿ç”¨æ–¹æ³•ä¸Ždb.jsä¸­appçš„ä½¿ç”¨æ–¹æ³•ä¸€è‡´ï¼Œå¯¼å‡ºçš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æžœè¦ä½¿ç”¨å®ƒï¼Œå°±éœ€è¦åŠ ä¸Š**()**ã€‚

```js
//auth.js
module.exports = (options) => async (req, res, next) => { 
  //...
};
```



